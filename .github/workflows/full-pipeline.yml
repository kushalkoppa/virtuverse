name: Full Pipeline CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'Runner type (github-hosted or self-hosted)'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - self-hosted

# Limit permissions for security
permissions:
  contents: read
  actions: read

jobs:
  main-frontend:
    name: Main Frontend Build
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ./VirtuSpace/frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: VirtuSpace/frontend/package.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Run linter
        run: npm run lint
        continue-on-error: true
      
      - name: Build frontend
        run: npm run build

  main-backend:
    name: Main Backend Build
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ./VirtuSpace/backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: VirtuSpace/backend/package.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Run tests
        run: npm test
        continue-on-error: true

  envihub:
    name: EnviHub Platform
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ./VirtuSpace/EnviHub
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: VirtuSpace/EnviHub/package.json
      
      - name: Install root dependencies
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/EnviHub/frontend
        run: npm install
      
      - name: Run tests
        run: npm test
        continue-on-error: true
      
      - name: Build frontend
        run: npm run build
        continue-on-error: true

  planthub:
    name: PlantHub Platform
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ./VirtuSpace/PlantHub
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: VirtuSpace/PlantHub/package.json
      
      - name: Install root dependencies
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/PlantHub/frontend
        run: npm install
      
      - name: Run tests
        run: npm test
        continue-on-error: true
      
      - name: Build frontend
        run: npm run build
        continue-on-error: true

  v-orchestrator:
    name: V-Orchestrator Platform
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Build V-Orchestrator Frontend
        working-directory: ./VirtuSpace/V-Orchestrator/frontend
        run: |
          npm install
          npm run build
        continue-on-error: true
      
      - name: Build V-Orchestrator Backend
        working-directory: ./VirtuSpace/V-Orchestrator/backend
        run: |
          npm install
          npm test
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    needs: [main-frontend, main-backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./VirtuSpace/frontend
          push: false
          tags: virtuverse/frontend:test
        continue-on-error: true
      
      - name: Build Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./VirtuSpace/backend
          push: false
          tags: virtuverse/backend:test
        continue-on-error: true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [main-frontend, main-backend, envihub, planthub, v-orchestrator]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "=== Pipeline Execution Summary ==="
          echo "Runner: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}"
          echo "Main Frontend: ${{ needs.main-frontend.result }}"
          echo "Main Backend: ${{ needs.main-backend.result }}"
          echo "EnviHub: ${{ needs.envihub.result }}"
          echo "PlantHub: ${{ needs.planthub.result }}"
          echo "V-Orchestrator: ${{ needs.v-orchestrator.result }}"
          echo "=================================="
