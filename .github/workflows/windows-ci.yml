name: Windows CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - virtuverse-studio
          - virtuspace
          - envihub
          - planthub
          - v-orchestrator
      runner_type:
        description: 'Runner type'
        required: false
        default: 'VirtuGo'
        type: choice
        options:
          - windows-latest
          - VirtuGo
      deploy:
        description: 'Deploy to self-hosted runner'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Limit permissions for security
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '18'

jobs:
  # VirtuVerse Studio Build on Windows
  virtuverse-studio:
    name: VirtuVerse Studio (Windows)
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.component == 'all' || 
      inputs.component == 'virtuverse-studio'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: VirtuVerse-Studio/package.json
      
      - name: Install backend dependencies
        working-directory: ./VirtuVerse-Studio
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuVerse-Studio/frontend
        run: npm install
      
      - name: Create database directory
        working-directory: ./VirtuVerse-Studio
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path backend/database
          Write-Host "Database directory created"
      
      - name: Build frontend
        working-directory: ./VirtuVerse-Studio/frontend
        run: npm run build
        continue-on-error: true
      
      - name: Test backend startup
        working-directory: ./VirtuVerse-Studio
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock { 
            Set-Location $using:PWD
            npm start 
          }
          Start-Sleep -Seconds 10
          Stop-Job -Job $job
          Write-Host "Backend startup test completed"
        continue-on-error: true
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: virtuverse-studio-windows-build
          path: VirtuVerse-Studio/frontend/build/
          retention-days: 7

  # VirtuSpace Platform Build on Windows
  virtuspace:
    name: VirtuSpace Platform (Windows)
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.component == 'all' || 
      inputs.component == 'virtuspace'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install backend dependencies
        working-directory: ./VirtuSpace/backend
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/frontend
        run: npm install
      
      # Tests skipped as requested - tests are failing
      # - name: Run backend tests
      #   working-directory: ./VirtuSpace/backend
      #   run: npm test
      #   continue-on-error: true
      
      - name: Build frontend
        working-directory: ./VirtuSpace/frontend
        run: npm run build
        continue-on-error: true
      
      - name: Test backend startup
        working-directory: ./VirtuSpace/backend
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock { 
            Set-Location $using:PWD
            npm start 
          }
          Start-Sleep -Seconds 10
          Stop-Job -Job $job
          Write-Host "Backend startup test completed"
        continue-on-error: true
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: virtuspace-windows-dist
          path: VirtuSpace/frontend/dist/
          retention-days: 7

  # EnviHub Platform Build on Windows
  envihub:
    name: EnviHub Platform (Windows)
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.component == 'all' || 
      inputs.component == 'envihub'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: VirtuSpace/EnviHub/package.json
      
      - name: Install root dependencies
        working-directory: ./VirtuSpace/EnviHub
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/EnviHub/frontend
        run: npm install
      
      # Tests skipped as requested - EnviHub tests are failing
      # - name: Run tests
      #   working-directory: ./VirtuSpace/EnviHub
      #   run: npm test
      #   continue-on-error: true
      
      - name: Build frontend
        working-directory: ./VirtuSpace/EnviHub
        run: npm run build
        continue-on-error: true
      
      - name: Test backend startup
        working-directory: ./VirtuSpace/EnviHub
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock { 
            Set-Location $using:PWD
            npm start 
          }
          Start-Sleep -Seconds 10
          Stop-Job -Job $job
          Write-Host "Backend startup test completed"
        continue-on-error: true
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: envihub-windows-build
          path: VirtuSpace/EnviHub/frontend/build/
          retention-days: 7

  # PlantHub Platform Build on Windows
  planthub:
    name: PlantHub Platform (Windows)
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.component == 'all' || 
      inputs.component == 'planthub'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: VirtuSpace/PlantHub/package.json
      
      - name: Install root dependencies
        working-directory: ./VirtuSpace/PlantHub
        run: npm install
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/PlantHub/frontend
        run: npm install
      
      # Tests skipped as requested - tests are failing
      # - name: Run tests
      #   working-directory: ./VirtuSpace/PlantHub
      #   run: npm test
      #   continue-on-error: true
      
      - name: Build frontend
        working-directory: ./VirtuSpace/PlantHub
        run: npm run build
        continue-on-error: true
      
      - name: Test backend startup
        working-directory: ./VirtuSpace/PlantHub
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock { 
            Set-Location $using:PWD
            npm start 
          }
          Start-Sleep -Seconds 10
          Stop-Job -Job $job
          Write-Host "Backend startup test completed"
        continue-on-error: true
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: planthub-windows-build
          path: VirtuSpace/PlantHub/frontend/build/
          retention-days: 7

  # V-Orchestrator Platform Build on Windows
  v-orchestrator:
    name: V-Orchestrator Platform (Windows)
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      github.event_name != 'workflow_dispatch' || 
      inputs.component == 'all' || 
      inputs.component == 'v-orchestrator'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install frontend dependencies
        working-directory: ./VirtuSpace/V-Orchestrator/frontend
        run: npm install
      
      - name: Build frontend
        working-directory: ./VirtuSpace/V-Orchestrator/frontend
        run: npm run build
        continue-on-error: true
      
      - name: Install backend dependencies
        working-directory: ./VirtuSpace/V-Orchestrator/backend
        run: npm install
      
      # Tests skipped as requested - tests are failing
      # - name: Run backend tests
      #   working-directory: ./VirtuSpace/V-Orchestrator/backend
      #   run: npm test
      #   continue-on-error: true
      
      - name: Test backend startup
        working-directory: ./VirtuSpace/V-Orchestrator/backend
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock { 
            Set-Location $using:PWD
            npm start 
          }
          Start-Sleep -Seconds 10
          Stop-Job -Job $job
          Write-Host "Backend startup test completed"
        continue-on-error: true
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: v-orchestrator-windows-build
          path: VirtuSpace/V-Orchestrator/frontend/dist/
          retention-days: 7

  # Deployment job for Windows
  deploy:
    name: Deploy to Windows Self-Hosted Runner
    needs: [virtuverse-studio, virtuspace, envihub, planthub, v-orchestrator]
    runs-on: ${{ github.event.inputs.runner_type || (github.event_name == 'push' && github.ref == 'refs/heads/main' && 'VirtuGo') || 'windows-latest' }}
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Deploy VirtuVerse Studio
        shell: pwsh
        run: |
          Write-Host "=== Deploying VirtuVerse Studio on Windows ==="
          
          # Create deployment directories
          New-Item -ItemType Directory -Force -Path "C:\VirtuVerse\deployments\virtuverse-studio" | Out-Null
          
          # Deploy VirtuSpace Frontend
          if (Test-Path "./artifacts/virtuspace-windows-dist") {
            Write-Host "Deploying VirtuSpace Frontend..."
            New-Item -ItemType Directory -Force -Path "C:\VirtuVerse\deployments\virtuspace-frontend" | Out-Null
            Copy-Item -Path "./artifacts/virtuspace-windows-dist/*" -Destination "C:\VirtuVerse\deployments\virtuspace-frontend/" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "VirtuSpace Frontend deployed"
          }
          
          # Deploy EnviHub
          if (Test-Path "./artifacts/envihub-windows-build") {
            Write-Host "Deploying EnviHub..."
            New-Item -ItemType Directory -Force -Path "C:\VirtuVerse\deployments\envihub" | Out-Null
            Copy-Item -Path "./artifacts/envihub-windows-build/*" -Destination "C:\VirtuVerse\deployments\envihub/" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "EnviHub deployed"
          }
          
          # Deploy PlantHub
          if (Test-Path "./artifacts/planthub-windows-build") {
            Write-Host "Deploying PlantHub..."
            New-Item -ItemType Directory -Force -Path "C:\VirtuVerse\deployments\planthub" | Out-Null
            Copy-Item -Path "./artifacts/planthub-windows-build/*" -Destination "C:\VirtuVerse\deployments\planthub/" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "PlantHub deployed"
          }
          
          # Deploy V-Orchestrator
          if (Test-Path "./artifacts/v-orchestrator-windows-build") {
            Write-Host "Deploying V-Orchestrator..."
            New-Item -ItemType Directory -Force -Path "C:\VirtuVerse\deployments\v-orchestrator" | Out-Null
            Copy-Item -Path "./artifacts/v-orchestrator-windows-build/*" -Destination "C:\VirtuVerse\deployments\v-orchestrator/" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "V-Orchestrator deployed"
          }
          
          Write-Host "=== Deployment completed ==="
      
      - name: Deployment summary
        shell: pwsh
        run: |
          Write-Host "=== Deployment Summary ==="
          Write-Host "Runner: VirtuGo (Windows self-hosted)"
          Write-Host "Branch: ${{ github.ref_name }}"
          Write-Host "Commit: ${{ github.sha }}"
          Write-Host "Deployed components:"
          Get-ChildItem -Path "C:\VirtuVerse\deployments" -Directory -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          Write-Host "=========================="
          Write-Host ""
          Write-Host "Access VirtuVerse Studio at:"
          Write-Host "  VirtuSpace: http://<vm-ip>:3003"
          Write-Host "  EnviHub: http://<vm-ip>:3001"
          Write-Host "  PlantHub: http://<vm-ip>:3002"
          Write-Host "  V-Orchestrator: http://<vm-ip>:3005"

  # Summary job
  summary:
    name: Windows Build Summary
    runs-on: windows-latest
    needs: [virtuverse-studio, virtuspace, envihub, planthub, v-orchestrator]
    if: always()
    
    steps:
      - name: Check build status
        shell: pwsh
        run: |
          Write-Host "=== Windows Pipeline Execution Summary ==="
          Write-Host "VirtuVerse Studio: ${{ needs.virtuverse-studio.result }}"
          Write-Host "VirtuSpace: ${{ needs.virtuspace.result }}"
          Write-Host "EnviHub: ${{ needs.envihub.result }}"
          Write-Host "PlantHub: ${{ needs.planthub.result }}"
          Write-Host "V-Orchestrator: ${{ needs.v-orchestrator.result }}"
          Write-Host "========================================"
